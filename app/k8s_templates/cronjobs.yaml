apiVersion: batch/v1
kind: CronJob
metadata:
  name: reset-namespaces
  namespace: zerofiltretech-${env_name}
spec:
  schedule: "0 0 1 * *"  # Run at midnight on the first day of every month
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            vault.hashicorp.com/agent-inject: "true"
            vault.hashicorp.com/role: "internal-app"
            vault.hashicorp.com/agent-inject-secret-config: "${env_name}/data/zerofiltre-provisioner"
            vault.hashicorp.com/agent-inject-template-config: |
              {{- with secret "${env_name}/data/zerofiltre-provisioner" -}}
                VERIFICATION_TOKEN="{{ .Data.data.VERIFICATION_TOKEN}}"
              {{- end -}}
        spec:
          serviceAccountName: internal-app
          containers:
          - name: reset-namespaces
            image: curlimages/curl:latest
            command:
            - /bin/sh
            - -c
            - |
              source /vault/secrets/config
              curl -X POST http://zerofiltretech-provisioner-${env_name}.zerofiltretech-${env_name}.svc.cluster.local:5000/reset \
                -H "Authorization: $VERIFICATION_TOKEN" \
                -H "Content-Type: application/json"
          restartPolicy: OnFailure
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cleanup-old-users
  namespace: zerofiltretech-${env_name}
spec:
  schedule: "0 0 * * *"  # Run at midnight every day
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        metadata:
          annotations:
            vault.hashicorp.com/agent-inject: "true"
            vault.hashicorp.com/role: "internal-app"
            vault.hashicorp.com/agent-inject-secret-config: "${env_name}/data/zerofiltre-provisioner"
            vault.hashicorp.com/agent-inject-template-config: |
              {{- with secret "${env_name}/data/zerofiltre-provisioner" -}}
                VERIFICATION_TOKEN="{{ .Data.data.VERIFICATION_TOKEN}}"
              {{- end -}}
        spec:
          serviceAccountName: internal-app
          containers:
          - name: cleanup-old-users
            image: curlimages/curl:latest
            command:
            - /bin/sh
            - -c
            - |
              source /vault/secrets/config
              curl -X POST http://zerofiltretech-provisioner-${env_name}.zerofiltretech-${env_name}.svc.cluster.local:5000/cleanup \
                -H "Authorization: $VERIFICATION_TOKEN" \
                -H "Content-Type: application/json"
          restartPolicy: OnFailure 